# Mythbusters: Putting Fantasy Football Beliefs/Anecdotes to the Test {#sec-mythbusters}

## Getting Started {#sec-mythbustersGettingStarted}

### Load Packages {#sec-mythbustersLoadPackages}

```{r}
library("petersenlab")
library("lme4")
library("lmerTest")
library("tidyverse")
```

### Load Data {#sec-mythbustersLoadData}

```{r}
load(file = "./data/nfl_playerContracts.RData")
load(file = "./data/nfl_actualStats_weekly.RData")
load(file = "./data/nfl_actualStats_seasonal.RData")
load(file = "./data/nfl_espnQBR.RData")
```

## Do Players Perform Better in their Contract Year? {#sec-contractYear}

Considerable speculation exists regarding whether players perform better in their last year of their contract (i.e., their "contract year").
Fantasy football talking heads and commentators frequently discuss the benefit of selecting players who are in their contract year, because it supposedly means that player has more motivation to perform well so they get a new contract and get paid more.
To our knowledge, no peer-reviewed studies have examined this question for football players.
One study found that National Basketball Association (NBA) players improved in field goal percentage, points, and player efficiency rating (but not other statistics: rebounds, assists, steals, or blocks) from their pre-contract year to their contract year, and that Major League Baseball (MLB) players improved in runs batted in (RBIs; but not other statistics: batting average, slugging percentage, on base percentage, home runs, fielding percentage) from their pre-contract year to their contract year [White2014a].
Other casual analyses have been examined contract-year performance of National Football League (NFL) players, including articles in [2012](https://www.4for4.com/2012/preseason/2012-contract-year-players-and-myth-increased-production) (archived [here](https://perma.cc/CT3F-QN5E)) and [2022](https://www.4for4.com/2022/preseason/do-players-perform-better-fantasy-football-contract-year) (archived [here](https://perma.cc/F4F5-7RQZ)).

Let's examine the question empirically.
In order to do that, we have to make some assumptions/constraints.
In this example, we will make the following constraints:

- We will examine seasons since 2011, beginning when most data for player contracts are available.
- For maximum [statistical power](#sec-statisticalPower) to detect an effect if a contract year effect exists, we will examine all seasons for a player (since 2011), not just their contract year and their pre-contract year.
- To ensure a more fair, apples-to-apples comparison of the games in which players played, we will examine *per-game* performance (except for yards per carry, which is based on $\frac{\text{rushing yards}}{\text{carries}}$ from the entire season).
- We will examine regular season games only (no postseason).
- To ensure we do not make generalization about a player's performance in a season from a small sample, the player has to play at least 5 games in a given season for that playerâ€“season combination to be included in analysis.

```{r}
#| code-fold: true

# Subset to remove players without a year signed
nfl_playerContracts_subset <- nfl_playerContracts %>% 
  dplyr::filter(!is.na(year_signed) & year_signed != 0)

# Determine the contract year for a given contract
nfl_playerContracts_subset$contractYear <- nfl_playerContracts_subset$year_signed + nfl_playerContracts_subset$years - 1

# Arrange contracts by player and year_signed
nfl_playerContracts_subset <- nfl_playerContracts_subset %>%
  dplyr::group_by(player, position) %>% 
  dplyr::arrange(player, position, -year_signed) %>% 
  dplyr::ungroup()

# Determine if the player played in the original contract year
nfl_playerContracts_subset <- nfl_playerContracts_subset %>%
  dplyr::group_by(player, position) %>%
  dplyr::mutate(
    next_contract_start = lag(year_signed)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    played_in_contract_year = ifelse(
      is.na(next_contract_start) | contractYear < next_contract_start,
      TRUE,
      FALSE))

# Check individual players
#nfl_playerContracts_subset %>% 
#  dplyr::filter(player == "Aaron Rodgers") %>% 
#  dplyr::select(player:years, contractYear, next_contract_start, played_in_contract_year)
#
#nfl_playerContracts_subset %>% 
#  dplyr::filter(player %in% c("Jared Allen", "Aaron Rodgers")) %>% 
#  dplyr::select(player:years, contractYear, next_contract_start, played_in_contract_year)

# Subset data
nfl_playerContractYears <- nfl_playerContracts_subset %>% 
  dplyr::filter(played_in_contract_year == TRUE) %>% 
  dplyr::filter(position %in% c("QB","RB","WR","TE")) %>% 
  dplyr::select(player, position, team, contractYear) %>% 
  dplyr::mutate(playerMerge = toupper(str_replace_all(player, "[[:punct:]]", ""))) %>% 
  dplyr::rename(season = contractYear) %>% 
  dplyr::mutate(contractYear = 1)

# Merge with weekly and seasonal stats data
nfl_actualStats_offense_weekly <- nfl_actualStats_offense_weekly %>% 
  dplyr::mutate(playerMerge = toupper(str_replace_all(player_display_name, "[[:punct:]]", "")))
#nfl_actualStats_offense_seasonal <- nfl_actualStats_offense_seasonal %>% 
#  mutate(playerMerge = toupper(str_replace_all(player_display_name, "[[:punct:]]", "")))

nfl_actualStatsContracts_offense_weekly <- dplyr::full_join(
  nfl_actualStats_offense_weekly,
  nfl_playerContractYears,
  by = c("playerMerge", "position_group" = "position", "season")
) %>% 
  dplyr::filter(position_group %in% c("QB","RB","WR","TE"))

#nfl_actualStatsContracts_offense_seasonal <- full_join(
#  nfl_actualStats_offense_seasonal,
#  nfl_playerContractYears,
#  by = c("playerMerge", "position_group" = "position", "season")
#) %>% 
#  filter(position_group %in% c("QB","RB","WR","TE"))

nfl_actualStatsContracts_offense_weekly$contractYear[which(is.na(nfl_actualStatsContracts_offense_weekly$contractYear))] <- 0
#nfl_actualStatsContracts_offense_seasonal$contractYear[which(is.na(nfl_actualStatsContracts_offense_seasonal$contractYear))] <- 0

nfl_actualStatsContracts_offense_weekly <- nfl_actualStatsContracts_offense_weekly %>% 
  dplyr::arrange(playerMerge, season, season_type, week)

#nfl_actualStatsContracts_offense_seasonal <- nfl_actualStatsContracts_offense_seasonal %>% 
#  arrange(playerMerge, season)

nfl_actualStatsContractsSubset_offense_weekly <- nfl_actualStatsContracts_offense_weekly %>% 
  dplyr::filter(season_type == "REG")

#table(nfl_playerContracts$year_signed) # most contract data is available beginning in 2011

# Calculate Per Game Totals
nfl_actualStatsContracts_seasonal <- nfl_actualStatsContractsSubset_offense_weekly %>% 
  dplyr::group_by(playerMerge, season) %>% 
  dplyr::summarise(
    position_group = petersenlab::Mode(position_group),
    rushing_yards = sum(rushing_yards, na.rm = TRUE), # season total
    carries = sum(carries, na.rm = TRUE), # season total
    rushing_epa = mean(rushing_epa, na.rm = TRUE),
    receiving_yards = mean(receiving_yards, na.rm = TRUE),
    receiving_epa = mean(receiving_epa, na.rm = TRUE),
    contractYear = mean(contractYear, na.rm = TRUE),
    games = n(),
    .groups = "drop_last"
  ) %>% 
  dplyr::mutate(ypc = rushing_yards / carries)

# Merge with seasonal fantasy points data
```

### QB

First, we prepare the data by merging and performing additional processing:

```{r}
#| code-fold: true

# Merge with QBR data
nfl_espnQBR$playerMerge <- paste(nfl_espnQBR$name_first, nfl_espnQBR$name_last, sep = " ") %>% 
  stringr::str_replace_all(., "[[:punct:]]", "") %>% 
  toupper()

nfl_contractYearQBR_weekly <- nfl_playerContractYears %>% 
  dplyr::filter(position == "QB") %>% 
  dplyr::full_join(
    .,
    nfl_espnQBR,
    by = c("playerMerge","team","season")
  )

nfl_contractYearQBR_weekly$contractYear[which(is.na(nfl_contractYearQBR_weekly$contractYear))] <- 0

nfl_contractYearQBR_weekly <- nfl_contractYearQBR_weekly %>% 
  dplyr::arrange(playerMerge, season, season_type, game_week)

nfl_contractYearQBRsubset_weekly <- nfl_contractYearQBR_weekly %>% 
  dplyr::filter(
    season_type == "Regular",
    game_week != "Season Total") %>% 
  dplyr::mutate(game_week = as.numeric(game_week)) %>% 
  dplyr::arrange(playerMerge, season, season_type, game_week)

#hist(nfl_contractYearQBRsubset_weekly$qb_plays) # players have at least 20 dropbacks per game

# Calculate Per Game Totals
nfl_contractYearQBR_seasonal <- nfl_contractYearQBRsubset_weekly %>% 
  dplyr::group_by(playerMerge, season) %>% 
  dplyr::summarise(
    qbr = mean(qbr_total, na.rm = TRUE),
    pts_added = mean(pts_added, na.rm = TRUE),
    epa_pass = mean(pass, na.rm = TRUE),
    qb_plays = sum(qb_plays, na.rm = TRUE), # season total
    contractYear = mean(contractYear, na.rm = TRUE),
    games = n(),
    .groups = "drop_last"
  )

nfl_contractYearQBRsubset_seasonal <- nfl_contractYearQBR_seasonal %>% 
  dplyr::filter(
    games >= 5, # keep only player-season combinations in which QBs played at least 5 games
    season >= 2011) # keep only seasons since 2011 (when most contract data are available)
```

Then, we analyze the data.
Below is a mixed model that examines whether a player has a higher QBR per game when they are in a contract year compared to when they are not in a contract year.

```{r}
mixedModel_qbr <- lmerTest::lmer(
  qbr ~ contractYear + (1 | playerMerge),
  data = nfl_contractYearQBR_seasonal
)

summary(mixedModel_qbr)
```

```{r}
mixedModel_ptsAdded <- lmerTest::lmer(
  pts_added ~ contractYear + (1 | playerMerge),
  data = nfl_contractYearQBR_seasonal
)

summary(mixedModel_ptsAdded)
```

```{r}
mixedModel_epaPass <- lmerTest::lmer(
  epa_pass ~ contractYear + (1 | playerMerge),
  data = nfl_contractYearQBR_seasonal
)

summary(mixedModel_epaPass)
```

```{r}
# Placeholder for model predicting fantasy points
```

### RB

```{r}
#| code-fold: true

nfl_actualStatsContractsRB_seasonal <- nfl_actualStatsContracts_seasonal %>% 
  dplyr::filter(
    position_group == "RB",
    games >= 5, # keep only player-season combinations in which QBs played at least 5 games
    season >= 2011) # keep only seasons since 2011 (when most contract data are available)
```

```{r}
mixedModel_ypc <- lmerTest::lmer(
  ypc ~ contractYear + (1 | playerMerge),
  data = nfl_actualStatsContractsRB_seasonal
)

summary(mixedModel_ypc)
```

```{r}
mixedModel_epaRush <- lmerTest::lmer(
  rushing_epa ~ contractYear + (1 | playerMerge),
  data = nfl_actualStatsContractsRB_seasonal
)

summary(mixedModel_epaRush)
```

```{r}
# Placeholder for model predicting fantasy points
```

### WR/TE

```{r}
#| code-fold: true

nfl_actualStatsContractsWRTE_seasonal <- nfl_actualStatsContracts_seasonal %>% 
  dplyr::filter(
    position_group %in% c("WR","TE"),
    games >= 5, # keep only player-season combinations in which QBs played at least 5 games
    season >= 2011) # keep only seasons since 2011 (when most contract data are available)
```

```{r}
mixedModel_receivingYards <- lmerTest::lmer(
  receiving_yards ~ contractYear + (1 | playerMerge),
  data = nfl_actualStatsContractsWRTE_seasonal
)

summary(mixedModel_receivingYards)
```

```{r}
mixedModel_epaReceiving <- lmerTest::lmer(
  receiving_epa ~ contractYear + (1 | playerMerge),
  data = nfl_actualStatsContractsWRTE_seasonal
)

summary(mixedModel_epaReceiving)
```

```{r}
# Placeholder for model predicting fantasy points
```

### QB/RB/WR/TE

```{r}
# Placeholder for model predicting fantasy points
# Include player position as a covariate
```

## Conclusion {#sec-mythbustersConclusion}

::: {.content-visible when-format="html"}

## Session Info {#sec-mythbustersSessionInfo}

```{r}
sessionInfo()
```

:::

# Download and Process NFL Football Data {#sec-downloadFootballData}

## Load Packages {#sec-loadPackages}

```{r}
library("ffanalytics")
library("nflreadr")
library("nflfastR")
library("nfl4th")
library("nflplotR")
library("progressr")
library("lubridate")
library("tidyverse")
```

## Data Dictionaries of NFL Data {#sec-dataDictionary}

Data Dictionaries are metadata that describe the meaning of the variables in a dataset.
You can find Data Dictionaries for the various National Football League (NFL) datasets at the following link: <https://nflreadr.nflverse.com/articles/index.html>.

## Types of NFL Data {#sec-downloadFootballDataOverview}

Below, we provide examples for how to download various types of NFL data.
For additional resources, @Congelio2023 provides a helpful introductory text for working with NFL data in `R`.
We save each data file after downloading it, so we can use the data in subsequent chapters.
Guidance for how to merge the various data files is provided at the following link: <https://github.com/nflverse/nfldata/blob/master/DATASETS.md>

```{r}
#| eval: false
#| include: false

# Downloaded Data - Raw
load(file = "./data/nfl_players_raw.RData")
load(file = "./data/nfl_teams_raw.RData")
load(file = "./data/nfl_rosters_raw.RData")
load(file = "./data/nfl_rosters_weekly_raw.RData")
load(file = "./data/nfl_schedules_raw.RData")
load(file = "./data/nfl_combine_raw.RData")
load(file = "./data/nfl_draftPicks_raw.RData")
load(file = "./data/nfl_depthCharts_raw.RData")
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_pbp_raw.RData", fsep = ""))
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_4thdown_raw.RData", fsep = ""))
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_participation_raw.RData", fsep = ""))
load(file = "./data/nfl_actualStats_weekly_raw.RData")
load(file = "./data/nfl_injuries_raw.RData")
load(file = "./data/nfl_snapCounts_raw.RData")
load(file = "./data/nfl_espnQBR_seasonal_raw.RData")
load(file = "./data/nfl_espnQBR_weekly_raw.RData")
load(file = "./data/nfl_nextGenStats_weekly_raw.RData")
load(file = "./data/nfl_advancedStatsPFR_seasonal_raw.RData")
load(file = "./data/nfl_advancedStatsPFR_weekly_raw.RData")
load(file = "./data/nfl_playerContracts_raw.RData")
load(file = "./data/nfl_ftnCharting_raw.RData")
load(file = "./data/nfl_playerIDs_raw.RData")
load(file = "./data/nfl_rankings_draft_raw.RData")
load(file = "./data/nfl_rankings_weekly_raw.RData")
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_expectedFantasyPoints_weekly_raw.RData", fsep = ""))
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_expectedFantasyPoints_pbp_raw.RData", fsep = ""))

# Calculated Data - Raw
load(file = "./data/nfl_actualStats_career_raw.RData")
load(file = "./data/nfl_actualStats_seasonal_raw.RData")

# Downloaded Data - Processed
load(file = "./data/nfl_players.RData")
load(file = "./data/nfl_teams.RData")
load(file = "./data/nfl_rosters.RData")
load(file = "./data/nfl_rosters_weekly.RData")
load(file = "./data/nfl_schedules.RData")
load(file = "./data/nfl_combine.RData")
load(file = "./data/nfl_draftPicks.RData")
load(file = "./data/nfl_depthCharts.RData")
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_pbp.RData", fsep = ""))
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_4thdown.RData", fsep = ""))
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_participation.RData", fsep = ""))
load(file = "./data/nfl_actualStats_weekly.RData")
load(file = "./data/nfl_injuries.RData")
load(file = "./data/nfl_snapCounts.RData")
load(file = "./data/nfl_espnQBR_seasonal.RData")
load(file = "./data/nfl_espnQBR_weekly.RData")
load(file = "./data/nfl_nextGenStats_weekly.RData")
load(file = "./data/nfl_advancedStatsPFR_seasonal.RData")
load(file = "./data/nfl_advancedStatsPFR_weekly.RData")
load(file = "./data/nfl_playerContracts.RData")
load(file = "./data/nfl_ftnCharting.RData")
load(file = "./data/nfl_playerIDs.RData")
load(file = "./data/nfl_rankings_draft.RData")
load(file = "./data/nfl_rankings_weekly.RData")
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_expectedFantasyPoints_weekly.RData", fsep = ""))
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_expectedFantasyPoints_pbp.RData", fsep = ""))

# Calculated Data - Processed
load(file = "./data/nfl_actualStats_career.RData")
load(file = "./data/nfl_actualStats_seasonal.RData")
```

### Players {#sec-downloadPlayers}

```{r}
#| eval: false

nfl_players_raw <- progressr::with_progress(
  nflreadr::load_players())
```

```{r}
#| eval: false

save(
  nfl_players_raw,
  file = "./data/nfl_players_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_players_raw.RData")
```

The `nfl_players` object is in `player` form.
That is, each row should be uniquely identified by `gsis_id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_players <- nfl_players_raw %>% 
  select(gsis_id, everything()) %>% 
  arrange(display_name)
```

Let's check for duplicate `player` instances:

```{r}
nfl_players %>% 
  group_by(gsis_id) %>% 
  filter(n() > 1) %>% 
  head()
```

Let's do some data cleanup:
  
```{r}
# Convert missing values to NA
nfl_players[nfl_players == ""] <- NA

# Drop players with missing values for gsis_id
nfl_players <- nfl_players %>% 
  filter(!is.na(gsis_id))
```

```{r}
#| eval: false

save(
  nfl_players,
  file = "./data/nfl_players.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_players.RData")
```

### Teams {#sec-downloadTeams}

```{r}
#| eval: false

nfl_teams_raw <- progressr::with_progress(
  nflreadr::load_teams(current = TRUE))
```

```{r}
#| eval: false

save(
  nfl_teams_raw,
  file = "./data/nfl_teams_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_teams_raw.RData")
```

The `nfl_teams` object is in `team` form.
That is, each row should be uniquely identified by `team_id`.
Let's rearrange the data accordingly:

```{r}
nfl_teams <- nfl_teams_raw %>% 
  select(team_id, everything())
```

Let's check for duplicate `team` instances:
  
```{r}
nfl_teams %>% 
  group_by(team_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_teams,
  file = "./data/nfl_teams.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_teams.RData")
```

### Fantasy Player IDs {#sec-fantasyPlayerIDs}

A Data Dictionary for fantasy player ID data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_ff_playerids.html>
  
```{r}
#| eval: false

nfl_playerIDs_raw <- progressr::with_progress(
  nflreadr::load_ff_playerids())
```

```{r}
#| eval: false

save(
  nfl_playerIDs_raw,
  file = "./data/nfl_playerIDs_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_playerIDs_raw.RData")
```

The `nfl_playerIDs` object is in `player` form.
That is, each row should be uniquely identified by `mfl_id`.

```{r}
nfl_playerIDs <- nfl_playerIDs_raw %>% 
  arrange(name, mfl_id)
```

Let's check for duplicate `player` instances:

```{r}
nfl_playerIDs %>% 
  group_by(mfl_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_playerIDs %>% 
  filter(!is.na(gsis_id)) %>% 
  group_by(gsis_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_playerIDs,
  file = "./data/nfl_playerIDs.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_playerIDs.RData")
```

### Player Info {#sec-downloadPlayerInfo}

### Rosters {#sec-downloadRosters}

A Data Dictionary for rosters is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_rosters.html>

```{r}
#| eval: false

nfl_rosters_raw <- progressr::with_progress(
  nflreadr::load_rosters(seasons = TRUE))

nfl_rosters_weekly_raw <- progressr::with_progress(
  nflreadr::load_rosters_weekly(seasons = TRUE))
```

```{r}
#| eval: false

save(
  nfl_rosters_raw,
  file = "./data/nfl_rosters_raw.RData"
)

save(
  nfl_rosters_weekly_raw,
  file = "./data/nfl_rosters_weekly_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_rosters_raw.RData")
load(file = "./data/nfl_rosters_weekly_raw.RData")
```

The `nfl_rosters` object is in `player`-`season`-`team` form.
That is, each row should be uniquely identified by the combination of `gsis_id`, `season`, and `team`.
Let's rearrange the data accordingly:
  
```{r}
nfl_rosters <- nfl_rosters_raw %>% 
  select(gsis_id, season, team, week, everything()) %>% 
  arrange(full_name, gsis_id, season, team, week)
```

Let's check for duplicate `player`-`season`-`team` instances:

```{r}
nfl_rosters %>% 
  group_by(gsis_id, season, team) %>% 
  filter(n() > 1) %>% 
  head()
```

Let's do some data cleanup:
  
```{r}
# Drop players with missing values for gsis_id
nfl_rosters <- nfl_rosters %>% 
  filter(!is.na(gsis_id))

# Fill in missing values for a player in their duplicate instances, and then keep only the first of the duplicate instances
nfl_rosters <- nfl_rosters %>% 
  group_by(gsis_id, season, team) %>% 
  fill(names(.), .direction = "downup") %>% 
  slice_head(n = 1) %>% 
  ungroup()
```

Let's check again for duplicate `player`-`season`-`team` instances:

```{r}
nfl_rosters %>% 
  group_by(gsis_id, season, team) %>% 
  filter(n() > 1) %>% 
  head()
```

The `nfl_rosters_weekly` object is in `player`-`season`-`week` form.
That is, each row should be uniquely identified by the combination of `gsis_id`, `season`, and `week`.
Let's rearrange the data accordingly:
  
```{r}
nfl_rosters_weekly <- nfl_rosters_weekly_raw %>% 
  select(gsis_id, season, week, everything()) %>% 
  arrange(full_name, gsis_id, season, week)
```

Let's check for duplicate `player`-`season`-`week` instances:

```{r}
nfl_rosters_weekly %>% 
  group_by(gsis_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()
```

Let's do some data cleanup:
  
```{r}
# Drop players with missing values for gsis_id
nfl_rosters_weekly <- nfl_rosters_weekly %>% 
  filter(!is.na(gsis_id))

# Fill in missing values for a player in their duplicate instances, and then keep only the first of the duplicate instances
nfl_rosters_weekly <- nfl_rosters_weekly %>% 
  group_by(gsis_id, season, week) %>% 
  fill(names(.), .direction = "downup") %>% 
  slice_head(n = 1) %>% 
  ungroup()
```

Let's check again for duplicate `player`-`season`-`week` instances:

```{r}
nfl_rosters_weekly %>% 
  group_by(gsis_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_rosters,
  file = "./data/nfl_rosters.RData"
)

save(
  nfl_rosters_weekly,
  file = "./data/nfl_rosters_weekly.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_rosters.RData")
load(file = "./data/nfl_rosters_weekly.RData")
```

### Game Schedules {#sec-downloadSchedules}

A Data Dictionary for game schedules data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_schedules.html>

```{r}
#| eval: false

nfl_schedules_raw <- progressr::with_progress(
  nflreadr::load_schedules(seasons = TRUE))
```

```{r}
#| eval: false

save(
  nfl_schedules_raw,
  file = "./data/nfl_schedules_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_schedules_raw.RData")
```

The `nfl_schedules` object is in `game` form.
That is, each row should be uniquely identified by `game_id`.

```{r}
nfl_schedules <- nfl_schedules_raw
```

Let's check for duplicate `game` instances:
  
```{r}
nfl_schedules %>% 
  group_by(game_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_schedules,
  file = "./data/nfl_schedules.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_schedules.RData")
```

### The Combine {#sec-combine}

A Data Dictionary for data from the combine is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_combine.html>
  
```{r}
#| eval: false

nfl_combine_raw <- progressr::with_progress(
  nflreadr::load_combine(seasons = TRUE))
```

```{r}
#| eval: false

save(
  nfl_combine_raw,
  file = "./data/nfl_combine_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_combine_raw.RData")
```

The `nfl_combine` object is in `player` form.
That is, each row should be uniquely identified by the player's `id`.
However, there is no `gsis_id` variable to merge it easily with other datasets.
Some of the players have other `id` variables, including `pfr_id` and `cfb_id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_combine <- nfl_combine_raw %>% 
  select(pfr_id, cfb_id, everything()) %>% 
  arrange(season, player_name)
```

Let's check for duplicate `pfr_id` and `cfb_id` instances:

```{r}
nfl_combine %>% 
  group_by(pfr_id) %>% 
  filter(n() > 1, !is.na(pfr_id)) %>% 
  arrange(pfr_id) %>% 
  head()

nfl_combine %>% 
  group_by(cfb_id) %>% 
  filter(n() > 1, !is.na(cfb_id)) %>% 
  arrange(cfb_id) %>% 
  head()
```

However, these apparent duplicates appear to be different players:

```{r}
nfl_combine %>% 
  group_by(season, pfr_id, pos) %>% 
  filter(n() > 1, !is.na(pfr_id)) %>% 
  arrange(pfr_id) %>% 
  head()

nfl_combine %>% 
  group_by(season, cfb_id, pos) %>% 
  filter(n() > 1, !is.na(cfb_id)) %>% 
  arrange(cfb_id) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_combine,
  file = "./data/nfl_combine.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_combine.RData")
```

### Draft Picks {#sec-draftPicks}

A Data Dictionary for draft picks data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_draft_picks.html>

```{r}
#| eval: false

nfl_draftPicks_raw <- progressr::with_progress(
  nflreadr::load_draft_picks(seasons = TRUE))
```

```{r}
#| eval: false

save(
  nfl_draftPicks_raw,
  file = "./data/nfl_draftPicks_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_draftPicks_raw.RData")
```

The `nfl_draftPicks` object is in `player` form.
That is, each row should be uniquely identified by `gsis_id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_draftPicks <- nfl_draftPicks_raw %>% 
  select(gsis_id, everything()) %>% 
  arrange(pfr_player_name)
```

Let's check for duplicate `player` instances:

```{r}
nfl_draftPicks %>% 
  group_by(gsis_id) %>% 
  filter(n() > 1) %>% 
  head()
```

Let's do some data cleanup:
  
```{r}
# Convert missing values to NA
nfl_draftPicks[nfl_draftPicks == ""] <- NA

# Drop players with missing values for gsis_id
nfl_draftPicks <- nfl_draftPicks %>% 
  filter(!is.na(gsis_id))
```

Let's check again for duplicate `player` instances:

```{r}
nfl_draftPicks %>% 
  group_by(gsis_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_draftPicks,
  file = "./data/nfl_draftPicks.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_draftPicks.RData")
```

### Depth Charts {#sec-depthCharts}

A Data Dictionary for data from weekly depth charts is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_depth_charts.html>

```{r}
#| eval: false

nfl_depthCharts_raw <- progressr::with_progress(
  nflreadr::load_depth_charts(seasons = TRUE))
```

```{r}
#| eval: false

save(
  nfl_depthCharts_raw,
  file = "./data/nfl_depthCharts_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_depthCharts_raw.RData")
```

The `nfl_depthCharts` object is in `player`-`season`-`week`-`position` form.
That is, each row should be uniquely identified by the combination of `gsis_id`, `season`, `week`, and `depth_position`.
Let's rearrange the data accordingly:
  
```{r}
nfl_depthCharts <- nfl_depthCharts_raw %>% 
  select(gsis_id, season, week, depth_position, everything()) %>% 
  arrange(full_name, gsis_id, season, week, depth_position)
```

Let's check for duplicate `player`-`season`-`week`-`position` instances:

```{r}
nfl_depthCharts %>% 
  group_by(gsis_id, season, week, depth_position) %>% 
  filter(n() > 1) %>% 
  head()
```

Let's do some data cleanup:
  
```{r}
# Drop players with missing values for gsis_id
nfl_depthCharts <- nfl_depthCharts %>% 
  filter(!is.na(gsis_id))

# Fill in missing values for a player in their duplicate instances, and then keep only the first of the duplicate instances
nfl_depthCharts <- nfl_depthCharts %>% 
  group_by(gsis_id, season, week, depth_position) %>% 
  fill(names(.), .direction = "downup") %>% 
  slice_head(n = 1) %>% 
  ungroup()
```

Let's check again for duplicate `player`-`season`-`week`-`position` instances:

```{r}
nfl_depthCharts %>% 
  group_by(gsis_id, season, week, depth_position) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_depthCharts,
  file = "./data/nfl_depthCharts.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_depthCharts.RData")
```

### Play-By-Play Data {#sec-downloadPlayByPlay}

To download play-by-play data from prior weeks and seasons, we can use the `load_pbp()` function of the `nflreadr` package.
We add a progress bar using the `with_progress()` function from the `progressr` package because it takes a while to run.
A Data Dictionary for the play-by-play data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_pbp.html>

::: {#nte-downloadPlayByPlay .callout-note title="Downloading play-by-play data"}
Note: the following code takes a while to run.
:::

```{r}
#| eval: false

nfl_pbp_raw <- progressr::with_progress(
  nflreadr::load_pbp(seasons = TRUE))
```

```{r}
#| include: false

nfl_pbp_raw <- nflreadr::load_pbp(seasons = TRUE)
```

```{r}
save(
  nfl_pbp_raw,
  file = "./data/nfl_pbp_raw.RData"
)
```

```{r}
#| eval: false
#| include: false

load(file = "./data/nfl_pbp_raw.RData")
```

```{r}
#| eval: false
#| include: false

load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_pbp_raw.RData", fsep = ""))
```

The `nfl_pbp` object is in `game`-`drive`-`play` form.
That is, each row should be uniquely identified by the combination of `game_id`, `drive`, `play_id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_pbp <- nfl_pbp_raw %>% 
  select(game_id, drive, play_id, everything()) %>% 
  arrange(game_id, drive, play_id)
```

Let's check for duplicate `game`-`drive`-`play` instances:

```{r}
nfl_pbp %>% 
  group_by(game_id, drive, play_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
save(
  nfl_pbp,
  file = "./data/nfl_pbp.RData"
)
```

```{r}
#| include: false

# garbage collection
rm(nfl_pbp_raw)
gc()
```

```{r}
#| eval: false
#| include: false

load(file = "./data/nfl_pbp.RData")
```

```{r}
#| eval: false
#| include: false

load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_pbp.RData", fsep = ""))
```

### 4th Down Data {#sec-download4thDown}

::: {#nte-download4thDownData .callout-note title="Downloading 4th down data"}
Note: the following code takes a while to run.
:::

```{r}
#| output: false

nfl_4thdown_raw <- nfl4th::load_4th_pbp(seasons = 2014:nflreadr::most_recent_season())
```

```{r}
save(
  nfl_4thdown_raw,
  file = "./data/nfl_4thdown_raw.RData"
)
```

```{r}
#| eval: false
#| include: false

load(file = "./data/nfl_4thdown_raw.RData")
```

```{r}
#| eval: false
#| include: false

load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_4thdown_raw.RData", fsep = ""))
```

The `nfl_4thdown` object is in `game`-`drive`-`play` form.
That is, each row should be uniquely identified by the combination of `game_id`, `drive`, `play_id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_4thdown <- nfl_4thdown_raw %>% 
  select(game_id, drive, play_id, everything()) %>% 
  arrange(game_id, drive, play_id)
```

Let's check for duplicate `game`-`drive`-`play` instances:

```{r}
nfl_4thdown %>% 
  group_by(game_id, drive, play_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
save(
  nfl_4thdown,
  file = "./data/nfl_4thdown.RData"
)
```

```{r}
#| include: false

# garbage collection
rm(nfl_4thdown_raw)
rm(nfl_4thdown)
gc()
```

```{r}
#| eval: false
#| include: false

load(file = "./data/nfl_4thdown.RData")
```

```{r}
#| eval: false
#| include: false

load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_4thdown.RData", fsep = ""))
```

### Participation {#sec-downloadParticipation}

A Data Dictionary for the participation data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_participation.html>

```{r}
nfl_participation_raw <- progressr::with_progress(
  nflreadr::load_participation(
    seasons = TRUE,
    include_pbp = TRUE))
```

```{r}
save(
  nfl_participation_raw,
  file = "./data/nfl_participation_raw.RData"
)
```

```{r}
#| eval: false
#| include: false

load(file = "./data/nfl_participation_raw.RData")
```

```{r}
#| eval: false
#| include: false

load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_participation_raw.RData", fsep = ""))
```

The `nfl_participation` object is in `game`-`drive`-`play` form.
That is, each row should be uniquely identified by the combination of `nflverse_game_id`, `drive`, `play_id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_participation <- nfl_participation_raw %>% 
  select(nflverse_game_id, drive, play_id, everything()) %>% 
  arrange(nflverse_game_id, drive, play_id)
```

Let's check for duplicate `game`-`drive`-`play` instances:

```{r}
nfl_participation %>% 
  group_by(nflverse_game_id, drive, play_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
save(
  nfl_participation,
  file = "./data/nfl_participation.RData"
)
```

```{r}
#| include: false

# garbage collection
rm(nfl_participation_raw)
rm(nfl_participation)
gc()
```

```{r}
#| eval: false
#| include: false

load(file = "./data/nfl_participation.RData")
```

```{r}
#| eval: false
#| include: false

load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_participation.RData", fsep = ""))
```

### Historical Weekly Actual Player Statistics {#sec-downloadActualStats}

We can download historical week-by-week actual player statistics using the `load_player_stats()` function from the `nflreadr` package.
A Data Dictionary for statistics for offensive players is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_player_stats.html>.
A Data Dictionary for statistics for defensive players is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_player_stats_def.html>.

```{r}
#| eval: false

nfl_actualStats_offense_weekly_raw <- progressr::with_progress(
  nflreadr::load_player_stats(
    seasons = TRUE,
    stat_type = "offense"))

nfl_actualStats_defense_weekly_raw <- progressr::with_progress(
  nflreadr::load_player_stats(
    seasons = TRUE,
    stat_type = "defense"))

nfl_actualStats_kicking_weekly_raw <- progressr::with_progress(
  nflreadr::load_player_stats(
    seasons = TRUE,
    stat_type = "kicking"))
```

```{r}
#| eval: false

save(
  nfl_actualStats_offense_weekly_raw, nfl_actualStats_defense_weekly_raw, nfl_actualStats_kicking_weekly_raw,
  file = "./data/nfl_actualStats_weekly_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_actualStats_weekly_raw.RData")
```

The `nfl_actualStats_weekly` objects are in `player`-`season`-`week` form.
That is, each row should be uniquely identified by the combination of `player_id`, `season`, and `week`.
Let's rearrange the data accordingly:
  
```{r}
nfl_actualStats_offense_weekly <- nfl_actualStats_offense_weekly_raw %>% 
  select(player_id, season, week, everything()) %>% 
  arrange(player_display_name, player_id, season, week)

nfl_actualStats_defense_weekly <- nfl_actualStats_defense_weekly_raw %>% 
  select(player_id, season, week, everything()) %>% 
  arrange(player_display_name, player_id, season, week)

nfl_actualStats_kicking_weekly <- nfl_actualStats_kicking_weekly_raw %>% 
  select(player_id, season, week, everything()) %>% 
  arrange(player_display_name, player_id, season, week)
```

Let's check for duplicate `player`-`season`-`week` instances:

```{r}
nfl_actualStats_offense_weekly %>% 
  group_by(player_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_defense_weekly %>% 
  group_by(player_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_kicking_weekly %>% 
  group_by(player_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_actualStats_offense_weekly, nfl_actualStats_defense_weekly, nfl_actualStats_kicking_weekly,
  file = "./data/nfl_actualStats_weekly.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_actualStats_weekly.RData")
```

### Injuries {#sec-injuries}

A Data Dictionary for injury data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_injuries.html>

```{r}
#| eval: false

nfl_injuries_raw <- progressr::with_progress(
  nflreadr::load_injuries(seasons = TRUE))
```

```{r}
#| eval: false

save(
  nfl_injuries_raw,
  file = "./data/nfl_injuries_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_injuries_raw.RData")
```

The `nfl_injuries` object is in `player`-`season`-`week` form.
That is, each row should be uniquely identified by the combination of `gsis_id`, `season`, and `week`.
Let's rearrange the data accordingly:
  
```{r}
nfl_injuries <- nfl_injuries_raw %>% 
  select(gsis_id, season, week, everything()) %>% 
  arrange(full_name, gsis_id, season, week)
```

Let's check for duplicate `player`-`season`-`week` instances:

```{r}
nfl_injuries %>% 
  group_by(gsis_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_injuries,
  file = "./data/nfl_injuries.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_injuries.RData")
```

### Snap Counts {#sec-snapCounts}

A Data Dictionary for snap counts data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_snap_counts.html>

```{r}
#| eval: false

nfl_snapCounts_raw <- progressr::with_progress(
  nflreadr::load_snap_counts(seasons = TRUE))
```

```{r}
#| eval: false

save(
  nfl_snapCounts_raw,
  file = "./data/nfl_snapCounts_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_snapCounts_raw.RData")
```

The `nfl_snapCounts` object is in `game`-`player` form.
That is, each row should be uniquely identified by the combination of `game_id` and `pfr_player_id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_snapCounts <- nfl_snapCounts_raw %>% 
  select(game_id, pfr_player_id, everything()) %>% 
  arrange(game_id, pfr_player_id)
```

Let's check for duplicate `game` instances:

```{r}
nfl_snapCounts %>% 
  group_by(game_id, pfr_player_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_snapCounts,
  file = "./data/nfl_snapCounts.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_snapCounts.RData")
```

### ESPN QBR {#sec-espnQBR}

A Data Dictionary for ESPN QBR data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_espn_qbr.html>

```{r}
#| eval: false

nfl_espnQBR_seasonal_raw <- progressr::with_progress(
  nflreadr::load_espn_qbr(
    seasons = TRUE,
    summary_type = c("season")))

nfl_espnQBR_weekly_raw <- progressr::with_progress(
  nflreadr::load_espn_qbr(
    seasons = TRUE,
    summary_type = c("week")))
```

```{r}
#| eval: false

save(
  nfl_espnQBR_seasonal_raw,
  file = "./data/nfl_espnQBR_seasonal_raw.RData"
)

save(
  nfl_espnQBR_weekly_raw,
  file = "./data/nfl_espnQBR_weekly_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_espnQBR_seasonal_raw.RData")
load(file = "./data/nfl_espnQBR_weekly_raw.RData")
```

The `nfl_espnQBR_seasonal` object is in `player`-`season`-`season type` form, where `season type` refers to regular season versus postseason.
That is, each row should be uniquely identified by the combination of `player_id`, `season`, and `season_type`.
Let's rearrange the data accordingly:
  
```{r}
nfl_espnQBR_seasonal <- nfl_espnQBR_seasonal_raw %>% 
  select(player_id, season, season_type, everything()) %>% 
  arrange(name_display, player_id, season, season_type)
```

Let's check for duplicate `player`-`season`-`team` instances:

```{r}
nfl_espnQBR_seasonal %>% 
  group_by(player_id, season, season_type) %>% 
  filter(n() > 1) %>% 
  head()
```

The `nfl_espnQBR_weekly` object is in both `game`-`player` form and `player`-`season`-`season type`-`week` form, where `season type` refers to regular season versus postseason.
That is, each row should be uniquely identified by the combination of `gsis_id`, `season`, and `week` or by the combination of `player_id`, `season`, `season_type`, and `week_num`.
Let's rearrange the data accordingly:
  
```{r}
nfl_espnQBR_weekly <- nfl_espnQBR_weekly_raw %>% 
  select(player_id, season, season_type, week_num, everything()) %>% 
  arrange(name_display, player_id, season, season_type, week_num)
```

Let's check for duplicate `game`-`player` or `player`-`season`-`season type`-`week` instances:

```{r}
nfl_espnQBR_weekly %>% 
  arrange(game_id, player_id) %>% 
  group_by(game_id, player_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_espnQBR_weekly %>% 
  arrange(player_id, season, season_type, week_num) %>% 
  group_by(player_id, season, season_type, week_num) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_espnQBR_seasonal,
  file = "./data/nfl_espnQBR_seasonal.RData"
)

save(
  nfl_espnQBR_weekly,
  file = "./data/nfl_espnQBR_weekly.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_espnQBR_seasonal.RData")
load(file = "./data/nfl_espnQBR_weekly.RData")
```

### NFL Next Gen Stats {#sec-nextGenStats}

A Data Dictionary for NFL Next Gen Stats data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_nextgen_stats.html>

```{r}
#| eval: false

nfl_nextGenStats_pass_weekly_raw <- progressr::with_progress(
  nflreadr::load_nextgen_stats(
    seasons = TRUE,
    stat_type = c("passing")))

nfl_nextGenStats_rush_weekly_raw <- progressr::with_progress(
  nflreadr::load_nextgen_stats(
    seasons = TRUE,
    stat_type = c("rushing")))

nfl_nextGenStats_rec_weekly_raw <- progressr::with_progress(
  nflreadr::load_nextgen_stats(
    seasons = TRUE,
    stat_type = c("receiving")))

nfl_nextGenStats_weekly_raw <- bind_rows(
  nfl_nextGenStats_pass_weekly_raw,
  nfl_nextGenStats_rush_weekly_raw,
  nfl_nextGenStats_rec_weekly_raw
)
```

```{r}
#| eval: false

save(
  nfl_nextGenStats_weekly_raw,
  file = "./data/nfl_nextGenStats_weekly_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_nextGenStats_weekly_raw.RData")
```

The `nfl_nextGenStats_weekly` object is in `player`-`season`-`season type`-`week` form, where `season type` refers to regular season versus postseason.
That is, each row should be uniquely identified by the combination of `player_gsis_id`, `season`, `season_type`, and `week`.
Let's rearrange the data accordingly:
  
```{r}
nfl_nextGenStats_weekly <- nfl_nextGenStats_weekly_raw %>% 
  select(player_gsis_id, season, season_type, week, everything()) %>% 
  arrange(player_display_name, player_gsis_id, season, season_type)
```

Let's check for duplicate `player`-`season`-`season type`-`week` instances:

```{r}
nfl_nextGenStats_weekly %>% 
  group_by(player_gsis_id, season, season_type, week) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_nextGenStats_weekly,
  file = "./data/nfl_nextGenStats_weekly.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_nextGenStats_weekly.RData")
```

### Advanced Stats from Pro Football Reference {#sec-advancedStatsPFR}

A Data Dictionary for Pro Football Reference passing data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_pfr_passing.html>

```{r}
#| eval: false

nfl_advancedStatsPFR_pass_seasonal_raw <- progressr::with_progress(
  nflreadr::load_pfr_advstats(
    seasons = TRUE,
    stat_type = c("pass"),
    summary_level = c("season")))

nfl_advancedStatsPFR_pass_weekly_raw <- progressr::with_progress(
  nflreadr::load_pfr_advstats(
    seasons = TRUE,
    stat_type = c("pass"),
    summary_level = c("week")))

nfl_advancedStatsPFR_rush_seasonal_raw <- progressr::with_progress(
  nflreadr::load_pfr_advstats(
    seasons = TRUE,
    stat_type = c("rush"),
    summary_level = c("season")))

nfl_advancedStatsPFR_rush_weekly_raw <- progressr::with_progress(
  nflreadr::load_pfr_advstats(
    seasons = TRUE,
    stat_type = c("rush"),
    summary_level = c("week")))

nfl_advancedStatsPFR_rec_seasonal_raw <- progressr::with_progress(
  nflreadr::load_pfr_advstats(
    seasons = TRUE,
    stat_type = c("rec"),
    summary_level = c("season")))

nfl_advancedStatsPFR_rec_weekly_raw <- progressr::with_progress(
  nflreadr::load_pfr_advstats(
    seasons = TRUE,
    stat_type = c("rec"),
    summary_level = c("week")))

nfl_advancedStatsPFR_def_seasonal_raw <- progressr::with_progress(
  nflreadr::load_pfr_advstats(
    seasons = TRUE,
    stat_type = c("def"),
    summary_level = c("season")))

nfl_advancedStatsPFR_def_weekly_raw <- progressr::with_progress(
  nflreadr::load_pfr_advstats(
    seasons = TRUE,
    stat_type = c("def"),
    summary_level = c("week")))
```

```{r}
#| eval: false

save(
  nfl_advancedStatsPFR_pass_seasonal_raw,
  nfl_advancedStatsPFR_rush_seasonal_raw,
  nfl_advancedStatsPFR_rec_seasonal_raw,
  nfl_advancedStatsPFR_def_seasonal_raw,
  file = "./data/nfl_advancedStatsPFR_seasonal_raw.RData"
)

save(
  nfl_advancedStatsPFR_pass_weekly_raw,
  nfl_advancedStatsPFR_rush_weekly_raw,
  nfl_advancedStatsPFR_rec_weekly_raw,
  nfl_advancedStatsPFR_def_weekly_raw,
  file = "./data/nfl_advancedStatsPFR_weekly_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_advancedStatsPFR_seasonal_raw.RData")
load(file = "./data/nfl_advancedStatsPFR_weekly_raw.RData")
```

```{r}
nfl_advancedStatsPFR_pass_seasonal <- nfl_advancedStatsPFR_pass_seasonal_raw %>% 
  mutate(
    nameMerge = toupper(str_remove_all(player, "[[:punct:]]"))
  ) %>% 
  rename(
    player_name.pass = player
  )

nfl_advancedStatsPFR_rush_seasonal <- nfl_advancedStatsPFR_rush_seasonal_raw %>% 
  mutate(
    nameMerge = toupper(str_remove_all(player, "[[:punct:]]"))
  ) %>% 
  rename(
    player_name.rush = player,
    age.rush = age,
    team = tm
  )

nfl_advancedStatsPFR_rec_seasonal <- nfl_advancedStatsPFR_rec_seasonal_raw %>% 
  mutate(
    nameMerge = toupper(str_remove_all(player, "[[:punct:]]"))
  ) %>% 
  rename(
    player_name.rec = player,
    age.rec = age,
    team = tm
  )

nfl_advancedStatsPFR_def_seasonal <- nfl_advancedStatsPFR_def_seasonal_raw %>% 
  mutate(
    nameMerge = toupper(str_remove_all(player, "[[:punct:]]"))
  ) %>% 
  rename(
    player_name.def = player,
    age.def = age,
    team = tm
  )

nfl_advancedStatsPFR_pass_weekly <- nfl_advancedStatsPFR_pass_weekly_raw %>% 
  mutate(
    nameMerge = toupper(str_remove_all(pfr_player_name, "[[:punct:]]"))
  ) %>% 
  rename(
    player_name.pass = pfr_player_name,
    season.pass = season,
    week.pass = week,
    team.pass = team
  )

nfl_advancedStatsPFR_rush_weekly <- nfl_advancedStatsPFR_rush_weekly_raw %>% 
  mutate(
    nameMerge = toupper(str_remove_all(pfr_player_name, "[[:punct:]]"))
  ) %>% 
  rename(
    player_name.rush = pfr_player_name,
    season.rush = season,
    week.rush = week,
    team.rush = team
  )

nfl_advancedStatsPFR_rec_weekly <- nfl_advancedStatsPFR_rec_weekly_raw %>% 
  mutate(
    nameMerge = toupper(str_remove_all(pfr_player_name, "[[:punct:]]"))
  ) %>% 
  rename(
    player_name.rec = pfr_player_name,
    season.rec = season,
    week.rec = week,
    team.rec = team
  )

nfl_advancedStatsPFR_def_weekly <- nfl_advancedStatsPFR_def_weekly_raw %>% 
  mutate(
    nameMerge = toupper(str_remove_all(pfr_player_name, "[[:punct:]]"))
  ) %>% 
  rename(
    player_name.def = pfr_player_name,
    season.def = season,
    week.def = week,
    team.def = team
  )

nfl_advancedStatsPFR_seasonal_list <- list(
  nfl_advancedStatsPFR_pass_seasonal,
  nfl_advancedStatsPFR_rush_seasonal,
  nfl_advancedStatsPFR_rec_seasonal,
  nfl_advancedStatsPFR_def_seasonal)

nfl_advancedStatsPFR_weekly_list <- list(
  nfl_advancedStatsPFR_pass_weekly,
  nfl_advancedStatsPFR_rush_weekly,
  nfl_advancedStatsPFR_rec_weekly,
  nfl_advancedStatsPFR_def_weekly)

nfl_advancedStatsPFR_seasonal <- nfl_advancedStatsPFR_seasonal_list %>% 
  purrr::reduce(
    full_join,
    by = c("pfr_id","nameMerge","season","team"))

nfl_advancedStatsPFR_weekly <- nfl_advancedStatsPFR_weekly_list %>% 
  purrr::reduce(
    full_join,
    by = c("game_id","pfr_player_id")) #nameMerge

#nfl_advancedStatsPFR_weekly <- nfl_advancedStatsPFR_weekly_list %>% 
#  purrr::reduce(
#    full_join,
#    by = c("pfr_player_id","nameMerge","season","week"))

nfl_advancedStatsPFR_seasonal <- nfl_advancedStatsPFR_seasonal %>% 
  mutate(
    player_name = coalesce(
      player_name.pass,
      player_name.rush,
      player_name.rec,
      player_name.def
    ),
    age = coalesce(
      #age.pass,
      age.rush,
      age.rec,
      age.def
    )
  ) %>% 
  select(-c(starts_with("player_name.")))

nfl_advancedStatsPFR_weekly <- nfl_advancedStatsPFR_weekly %>% 
  mutate(
    player_name = coalesce(
      player_name.pass,
      player_name.rush,
      player_name.rec,
      player_name.def
    ),
    ,
    season = coalesce(
      season.pass,
      season.rush,
      season.rec,
      season.def
    ),
    week = coalesce(
      week.pass,
      week.rush,
      week.rec,
      week.def
    ),
    team = coalesce(
      team.pass,
      team.rush,
      team.rec,
      team.def
    )
  ) %>% 
  select(-c(starts_with("player_name.")))

# Todo:
#-separate variables from each pass/rush/rec/def object
```

The `nfl_advancedStatsPFR_seasonal` object is in `player`-`season`-`team` form.
That is, each row should be uniquely identified by the combination of `pfr_id`, `season`, and `team`.
Let's rearrange the data accordingly:
  
```{r}
nfl_advancedStatsPFR_seasonal <- nfl_advancedStatsPFR_seasonal %>% 
  select(pfr_id, season, team, player_name, everything()) %>% 
  arrange(player_name, pfr_id, season, team)
```

Let's check for duplicate `player`-`season`-`team` instances:

```{r}
nfl_advancedStatsPFR_seasonal %>% 
  group_by(pfr_id, season, team) %>% 
  filter(n() > 1) %>% 
  head()
```

The `nfl_advancedStatsPFR_weekly` object is in both `game`-`player` form and `player`-`season`-`week` form.
That is, each row should be uniquely identified by the combination of `gsis_id`, `season`, and `week` or by the combination of `player_id`, `season`, `season_type`, and `week_num`.
Let's rearrange the data accordingly:
  
```{r}
nfl_advancedStatsPFR_weekly <- nfl_advancedStatsPFR_weekly %>% 
  select(pfr_player_id, season, week, everything()) %>% 
  arrange(player_name, pfr_player_id, season, week)
```

Let's check for duplicate `game`-`player` or `player`-`season`-`week` instances:

```{r}
nfl_advancedStatsPFR_weekly %>% 
  arrange(game_id, pfr_player_id) %>% 
  group_by(game_id, pfr_player_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_advancedStatsPFR_weekly %>% 
  arrange(pfr_player_id, season, week) %>% 
  group_by(pfr_player_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()
```

Merge with `gsis_id` for merging with other datasets:

```{r}
# Prepare data for merging
nfl_advancedStatsPFR_weekly <- nfl_advancedStatsPFR_weekly %>% 
  rename(pfr_id = pfr_player_id)

# Identify duplicates
nfl_advancedStatsPFR_seasonal %>% 
  select(pfr_id, season, age) %>% 
  na.omit() %>% 
  unique() %>% 
  group_by(pfr_id, season) %>% 
  filter(n() > 1) %>% 
  arrange(pfr_id, season) %>% 
  head()

# Merge seasonal data with the player IDs
nfl_advancedStatsPFR_seasonal <- left_join(
  nfl_advancedStatsPFR_seasonal,
  nfl_playerIDs %>% 
    filter(!is.na(pfr_id)) %>% 
    filter(gsis_id != "00-0039137") %>% # drop DL Byron Young, keep OLB Byron Young
    select(pfr_id, gsis_id) %>% 
    unique(),
  by = "pfr_id"
)

# Merge weekly data with the player IDs
nfl_advancedStatsPFR_weekly <- left_join(
  nfl_advancedStatsPFR_weekly,
  nfl_playerIDs %>% 
    filter(!is.na(pfr_id)) %>% 
    filter(gsis_id != "00-0039137") %>% # drop DL Byron Young, keep OLB Byron Young
    select(pfr_id, gsis_id) %>% 
    unique(),
  by = "pfr_id"
)

# Remove distinct players who were given the same `pfr_id` (to allow merging)
nfl_advancedStatsPFR_seasonal$gsis_id[which(nfl_advancedStatsPFR_seasonal$gsis_id == "00-0035665" & nfl_advancedStatsPFR_seasonal$pos %in% c("LB","LILB","RILB"))] <- NA # drop LB David Young, keep DB David Young
#nfl_advancedStatsPFR_weekly$gsis_id[which(nfl_advancedStatsPFR_weekly$gsis_id == "00-0035665" & nfl_advancedStatsPFR_weekly$team %in% c("TEN","MIA"))] <- NA # drop LB David Young, keep DB David Young

nfl_advancedStatsPFR_seasonal$gsis_id[which(nfl_advancedStatsPFR_seasonal$gsis_id == "00-0035292" & nfl_advancedStatsPFR_seasonal$pos %in% c("LB","LILB","RILB"))] <- NA # drop LB David Young, keep DB David Young
nfl_advancedStatsPFR_weekly$gsis_id[which(nfl_advancedStatsPFR_weekly$gsis_id == "00-0035292" & nfl_advancedStatsPFR_weekly$team %in% c("TEN","MIA"))] <- NA # drop LB David Young, keep DB David Young

nfl_advancedStatsPFR_seasonal$gsis_id[which(nfl_advancedStatsPFR_seasonal$gsis_id == "00-0033894" & nfl_advancedStatsPFR_seasonal$pos == "DB")] <- NA # drop S Marcus Williams, keep DB David Young
#nfl_advancedStatsPFR_weekly$gsis_id[which(nfl_advancedStatsPFR_weekly$gsis_id == "00-0033894" & nfl_advancedStatsPFR_weekly$pos == "DB")] <- NA # drop S Marcus Williams

nfl_advancedStatsPFR_seasonal$gsis_id[which(nfl_advancedStatsPFR_seasonal$gsis_id == "00-0038407" & nfl_advancedStatsPFR_seasonal$pos == "DB")] <- NA # drop DB Jaylon Jones, keep CB Jaylon Jones
#nfl_advancedStatsPFR_weekly$gsis_id[which(nfl_advancedStatsPFR_weekly$gsis_id == "00-0038407" & nfl_advancedStatsPFR_weekly$pos == "DB")] <- NA # drop DB Jaylon Jones, keep CB Jaylon Jones

nfl_advancedStatsPFR_seasonal$gsis_id[which(nfl_advancedStatsPFR_seasonal$gsis_id == "00-0037106" & nfl_advancedStatsPFR_seasonal$pos == "DB")] <- NA # drop DB Jaylon Jones, keep CB Jaylon Jones
#nfl_advancedStatsPFR_weekly$gsis_id[which(nfl_advancedStatsPFR_weekly$gsis_id == "00-0037106" & nfl_advancedStatsPFR_weekly$pos == "DB")] <- NA # drop DB Jaylon Jones, keep CB Jaylon Jones

nfl_advancedStatsPFR_seasonal$gsis_id[which(nfl_advancedStatsPFR_seasonal$gsis_id == "00-0038549" & nfl_advancedStatsPFR_seasonal$pos == "WR")] <- NA # drop WR DJ TUrner, keep CB DJ Turner
#nfl_advancedStatsPFR_weekly$gsis_id[which(nfl_advancedStatsPFR_weekly$gsis_id == "00-0038549" & nfl_advancedStatsPFR_weekly$pos == "WR")] <- NA # drop WR DJ TUrner, keep CB DJ Turner
```

Let's check again for duplicate `game`-`player` or `player`-`season`-`week` instances:
  
```{r}
nfl_advancedStatsPFR_seasonal %>% 
  group_by(pfr_id, season, team) %>% 
  filter(n() > 1) %>% 
  head()

nfl_advancedStatsPFR_weekly %>% 
  arrange(game_id, pfr_id) %>% 
  group_by(game_id, pfr_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_advancedStatsPFR_weekly %>% 
  arrange(pfr_id, season, week) %>% 
  group_by(pfr_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_advancedStatsPFR_seasonal,
  file = "./data/nfl_advancedStatsPFR_seasonal.RData"
)

save(
  nfl_advancedStatsPFR_weekly,
  file = "./data/nfl_advancedStatsPFR_weekly.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_advancedStatsPFR_seasonal.RData")
load(file = "./data/nfl_advancedStatsPFR_weekly.RData")
```

### Player Contracts {#sec-playerContracts}

A Data Dictionary for player contracts data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_contracts.html>
  
```{r}
#| eval: false

nfl_playerContracts_raw <- progressr::with_progress(
  nflreadr::load_contracts())
```

```{r}
#| eval: false

save(
  nfl_playerContracts_raw,
  file = "./data/nfl_playerContracts_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_playerContracts_raw.RData")
```

The `nfl_playerContracts` object is in `player`-`year`-`team`-`value` form.
That is, each row should be uniquely identified by the combination of `otc_id`, `year_signed`, `team`, and `value`.
Let's rearrange the data accordingly:

```{r}
nfl_playerContracts <- nfl_playerContracts_raw %>% 
  select(otc_id, year_signed, team, everything()) %>% 
  arrange(player, otc_id, year_signed, team)
```

Let's check for duplicate `player`-`year`-`team`-`value` instances:
  
```{r}
nfl_playerContracts %>% 
  group_by(otc_id, year_signed, team, value) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_playerContracts,
  file = "./data/nfl_playerContracts.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_playerContracts.RData")
```

### FTN Charting Data {#sec-ftnCharting}

A Data Dictionary for FTN Charting data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_ftn_charting.html>
  
```{r}
#| eval: false

nfl_ftnCharting_raw <- progressr::with_progress(
  nflreadr::load_ftn_charting(seasons = TRUE))
```

```{r}
#| eval: false

save(
  nfl_ftnCharting_raw,
  file = "./data/nfl_ftnCharting_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_ftnCharting_raw.RData")
```

The `nfl_ftnCharting` object is in `game`-`play` form.
That is, each row should be uniquely identified by the combination of `nflverse_game_id` and `play_id`.
Let's rearrange the data accordingly:

```{r}
nfl_ftnCharting <- nfl_ftnCharting_raw %>% 
  select(nflverse_game_id, nflverse_play_id, everything()) %>% 
  arrange(nflverse_game_id, nflverse_play_id)
```

Let's check for duplicate `game`-`drive`-`play` instances:
  
```{r}
nfl_ftnCharting %>% 
  group_by(nflverse_game_id, nflverse_play_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_ftnCharting,
  file = "./data/nfl_ftnCharting.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_ftnCharting.RData")
```

### FantasyPros Rankings {#sec-fantasyProsRankings}

A Data Dictionary for FantasyPros ranking data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_ff_rankings.html>
  
```{r}
#| eval: false

#nfl_rankings_raw <- progressr::with_progress( # currently throws error
#  nflreadr::load_ff_rankings(type = "all"))

nfl_rankings_draft_raw <- progressr::with_progress(
  nflreadr::load_ff_rankings(type = "draft"))

nfl_rankings_weekly_raw <- progressr::with_progress(
  nflreadr::load_ff_rankings(type = "week"))
```

```{r}
#| eval: false

save(
  nfl_rankings_draft_raw,
  file = "./data/nfl_rankings_draft_raw.RData"
)

save(
  nfl_rankings_weekly_raw,
  file = "./data/nfl_rankings_weekly_raw.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_rankings_draft_raw.RData")
load(file = "./data/nfl_rankings_weekly_raw.RData")
```

The `nfl_rankings_draft` object is in `player`-`page_type` form.
That is, each row should be uniquely identified by the player's `id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_rankings_draft <- nfl_rankings_draft_raw %>% 
  select(id, page_type, player, pos, team, everything()) %>% 
  arrange(player, id, pos, page_type)
```

Let's check for duplicate `player`-`page_type` instances:

```{r}
nfl_rankings_draft %>% 
  group_by(id, page_type) %>% 
  filter(n() > 1) %>% 
  head()
```

The `nfl_rankings_weekly` object is in `player`-`page` form.
That is, each row should be uniquely identified by `fantasypros_id` and `page`.
Let's rearrange the data accordingly:
  
```{r}
nfl_rankings_weekly <- nfl_rankings_weekly_raw %>% 
  select(fantasypros_id, page, player_name, pos, team, everything()) %>% 
  arrange(player_name, fantasypros_id, page, pos)
```

Let's check for duplicate `player`-`page` instances:

```{r}
nfl_rankings_weekly %>% 
  group_by(fantasypros_id, page) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false

save(
  nfl_rankings_draft,
  file = "./data/nfl_rankings_draft.RData"
)

save(
  nfl_rankings_weekly,
  file = "./data/nfl_rankings_weekly.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_rankings_draft.RData")
load(file = "./data/nfl_rankings_weekly.RData")
```

### Expected Fantasy Points {#sec-expectedFantasyPoints}

A Data Dictionary for expected fantasy points data is located at the following link: <https://nflreadr.nflverse.com/articles/dictionary_ff_opportunity.html>

```{r}
#| eval: false

nfl_expectedFantasyPoints_weekly_raw <- progressr::with_progress(
  nflreadr::load_ff_opportunity(
    seasons = TRUE,
    stat_type = "weekly",
    model_version = "latest"
  ))

nfl_expectedFantasyPoints_pass_raw <- progressr::with_progress(
  nflreadr::load_ff_opportunity(
    seasons = TRUE,
    stat_type = "pbp_pass",
    model_version = "latest"
  ))

nfl_expectedFantasyPoints_rush_raw <- progressr::with_progress(
  nflreadr::load_ff_opportunity(
    seasons = TRUE,
    stat_type = "pbp_rush",
    model_version = "latest"
  ))
```

```{r}
nfl_expectedFantasyPoints_weekly_raw <- nflreadr::load_ff_opportunity(
  seasons = TRUE,
  stat_type = "weekly",
  model_version = "latest"
  )

nfl_expectedFantasyPoints_pass_raw <- nflreadr::load_ff_opportunity(
  seasons = TRUE,
  stat_type = "pbp_pass",
  model_version = "latest"
  )

nfl_expectedFantasyPoints_rush_raw <- nflreadr::load_ff_opportunity(
  seasons = TRUE,
  stat_type = "pbp_rush",
  model_version = "latest"
  )
```

```{r}
save(
  nfl_expectedFantasyPoints_weekly_raw,
  file = "./data/nfl_expectedFantasyPoints_weekly_raw.RData"
)

save(
  nfl_expectedFantasyPoints_pass_raw,
  nfl_expectedFantasyPoints_rush_raw,
  file = "./data/nfl_expectedFantasyPoints_pbp_raw.RData"
)
```

```{r}
#| eval: false
#| include: false

load(file = "./data/nfl_expectedFantasyPoints_weekly_raw.RData")
load(file = "./data/nfl_expectedFantasyPoints_pbp_raw.RData")
```

```{r}
#| eval: false
#| include: false

load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_expectedFantasyPoints_weekly_raw.RData", fsep = ""))
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_expectedFantasyPoints_pbp_raw.RData", fsep = ""))
```

```{r}
nfl_expectedFantasyPoints_pbp_list <- list(
  nfl_expectedFantasyPoints_pass_raw,
  nfl_expectedFantasyPoints_rush_raw)

nfl_expectedFantasyPoints_pbp <- full_join(
  nfl_expectedFantasyPoints_pass_raw,
  nfl_expectedFantasyPoints_rush_raw,
  by = c("game_id","fixed_drive","play_id"),
  suffix = c(".pass", ".rush")
)

# Todo:
#-separate variables from each pass/rush object
```

The `nfl_expectedFantasyPoints_weekly` object is in `game`-`player` form and in `player`-`season`-`week` form.
That is, each row should be uniquely identified by the combination of `game_id` and `player_id`.
Each row should also be uniquely identified by the combination of `player_id`, `season`, and `week`.
Let's rearrange the data accordingly:
  
```{r}
nfl_expectedFantasyPoints_weekly <- nfl_expectedFantasyPoints_weekly_raw %>% 
  select(player_id, season, week, game_id, full_name, posteam, position, everything()) %>% 
  arrange(full_name, player_id, season, week)
```

Let's check for duplicate `game`-`player` instances and `player`-`season`-`week` instances:

```{r}
nfl_expectedFantasyPoints_weekly %>% 
  group_by(game_id, player_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_expectedFantasyPoints_weekly %>% 
  group_by(player_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()
```

Let's do some data cleanup:
  
```{r}
# Drop players with missing values for player_id
nfl_expectedFantasyPoints_weekly <- nfl_expectedFantasyPoints_weekly %>% 
  filter(!is.na(player_id))
```

Let's check again for duplicate `game`-`player` instances and `season`-`week`-`player` instances:

```{r}
nfl_expectedFantasyPoints_weekly %>% 
  group_by(game_id, player_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_expectedFantasyPoints_weekly %>% 
  group_by(player_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()
```

The `nfl_expectedFantasyPoints_pbp` object is in `game`-`drive`-`play` form.
That is, each row should be uniquely identified by the combination of `game_id`, `fixed_drive`, and `play_id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_expectedFantasyPoints_pbp <- nfl_expectedFantasyPoints_pbp %>% 
  select(game_id, fixed_drive, play_id, everything()) %>% 
  arrange(game_id, fixed_drive, play_id)
```

Let's check for duplicate `game`-`player` instances and `season`-`week`-`player` instances:

```{r}
nfl_expectedFantasyPoints_pbp %>% 
  group_by(game_id, fixed_drive, play_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
save(
  nfl_expectedFantasyPoints_weekly,
  file = "./data/nfl_expectedFantasyPoints_weekly.RData"
)

save(
  nfl_expectedFantasyPoints_pbp,
  file = "./data/nfl_expectedFantasyPoints_pbp.RData"
)
```

```{r}
#| include: false

# garbage collection
rm(nfl_expectedFantasyPoints_weekly_raw)
rm(nfl_expectedFantasyPoints_pbp_raw)
rm(nfl_expectedFantasyPoints_weekly)
rm(nfl_expectedFantasyPoints_pbp)
gc()
```

```{r}
#| eval: false
#| include: false

load(file = "./data/nfl_expectedFantasyPoints_weekly.RData")
load(file = "./data/nfl_expectedFantasyPoints_pbp.RData")
```

```{r}
#| eval: false
#| include: false

load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_expectedFantasyPoints_weekly.RData", fsep = ""))
load(file = file.path(path, "/OneDrive - University of Iowa/Teaching/Courses/Fantasy Football/Data/nfl_expectedFantasyPoints_pbp.RData", fsep = ""))
```

## Calculations {#sec-calculations}

### Historical Actual Player Statistics {#sec-calculateActualStats}

In addition to week-by-week actual player statistics, we can also compute historical actual player statistics as a function of different timeframes, including season-by-season and career statistics.

#### Career Statistics {#sec-calculateActualCareerStats}

First, we can compute the players' career statistics using the `calculate_player_stats()`, `calculate_player_stats_def()`, and `calculate_player_stats_kicking()` functions from the `nflfastR` package for offensive players, defensive players, and kickers, respectively.

::: {#nte-calculateActualCareerStats .callout-note title="Calculating players' career statistics"}
Note: the following code takes a while to run.
:::

```{r}
#| eval: false

nfl_actualStats_offense_career_raw <- nflfastR::calculate_player_stats(
  nfl_pbp,
  weekly = FALSE)

nfl_actualStats_defense_career_raw <- nflfastR::calculate_player_stats_def(
  nfl_pbp,
  weekly = FALSE)

nfl_actualStats_kicking_career_raw <- nflfastR::calculate_player_stats_kicking(
  nfl_pbp,
  weekly = FALSE)
```

```{r}
#| eval: false

save(
  nfl_actualStats_offense_career_raw, nfl_actualStats_defense_career_raw, nfl_actualStats_kicking_career_raw,
  file = "./data/nfl_actualStats_career_raw.RData"
)
```

```{r}
#| include: false

load("./data/nfl_actualStats_career_raw.RData")
```

The `nfl_actualStats_career` objects are in `player` form.
That is, each row should be uniquely identified by the combination of `player_id`.
Let's rearrange the data accordingly:
  
```{r}
nfl_actualStats_offense_career <- nfl_actualStats_offense_career_raw %>% 
  arrange(player_display_name, player_id)

nfl_actualStats_defense_career <- nfl_actualStats_defense_career_raw %>% 
  arrange(player_display_name, player_id)

nfl_actualStats_kicking_career <- nfl_actualStats_kicking_career_raw %>% 
  arrange(player_display_name, player_id)
```

Let's check for duplicate `player` instances:

```{r}
nfl_actualStats_offense_career %>% 
  group_by(player_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_defense_career %>% 
  group_by(player_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_kicking_career %>% 
  group_by(player_id) %>% 
  filter(n() > 1) %>% 
  head()
```

Let's do some data cleanup:
  
```{r}
# Sum statistics across a player's years with multiple teams
nfl_actualStats_defense_career <- nfl_actualStats_defense_career %>% 
  group_by(player_id) %>% 
  summarise(
    across(where(is.numeric), ~ sum(.x, na.rm = TRUE)),
    .groups = "drop"
  )

nfl_actualStats_kicking_career <- nfl_actualStats_kicking_career %>% 
  group_by(player_id) %>% 
  summarise(
    across(where(is.numeric), ~ sum(.x, na.rm = TRUE)),
    .groups = "drop"
  )

# Re-calculate percentage stats
nfl_actualStats_kicking_career <- nfl_actualStats_kicking_career %>% 
  mutate(
    fg_pct = fg_made / fg_att,
    pat_pct = pat_made / pat_att
  )

# Merge data back with player info
nfl_actualStats_defense_career_raw_playerInfo <- nfl_actualStats_defense_career_raw %>% 
  select(player_id, player_name, player_display_name, position, position_group, team, headshot_url) %>% 
  unique() %>% 
  group_by(player_id) %>% 
  slice_head(n = 1) %>% 
  ungroup()

nfl_actualStats_kicking_career_raw_playerInfo <- nfl_actualStats_kicking_career_raw %>% 
  select(player_id, player_name, player_display_name, position, position_group, team, headshot_url) %>% 
  unique() %>% 
  group_by(player_id) %>% 
  slice_head(n = 1) %>% 
  ungroup()

nfl_actualStats_defense_career <- nfl_actualStats_defense_career_raw_playerInfo %>% 
  right_join(
    nfl_actualStats_defense_career,
    by = "player_id"
  )

nfl_actualStats_kicking_career <- nfl_actualStats_kicking_career_raw_playerInfo %>% 
  right_join(
    nfl_actualStats_kicking_career,
    by = "player_id"
  )

# Rearrange data
nfl_actualStats_defense_career <- nfl_actualStats_defense_career %>% 
  arrange(player_display_name, player_id)

nfl_actualStats_kicking_career <- nfl_actualStats_kicking_career %>% 
  arrange(player_display_name, player_id)
```

Let's check again for duplicate `player` instances:

```{r}
nfl_actualStats_offense_career %>% 
  group_by(player_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_defense_career %>% 
  group_by(player_id) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_kicking_career %>% 
  group_by(player_id) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false
#| include: false

save(
  nfl_actualStats_offense_career, nfl_actualStats_defense_career, nfl_actualStats_kicking_career,
  file = "./data/nfl_actualStats_career.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_actualStats_career.RData")
```

#### Season-by-Season Statistics {#sec-calculateActualSeasonalStats}

Second, we can compute the players' season-by-season statistics.

```{r}
seasons <- unique(nfl_pbp$season)

nfl_pbp_seasonalList <- list()
nfl_actualStats_offense_seasonalList <- list()
nfl_actualStats_defense_seasonalList <- list()
nfl_actualStats_kicking_seasonalList <- list()
```

::: {#nte-calculateActualSeasonalStats .callout-note title="Calculating players' season-by-season statistics"}
  Note: the following code takes a while to run.
  :::
    
```{r}
#| eval: false
  
pb <- txtProgressBar(
  min = 0,
  max = length(seasons),
  style = 3)
  
for(i in 1:length(seasons)){
  # Subset play-by-play data by season
  nfl_pbp_seasonalList[[i]] <- nfl_pbp %>% 
    dplyr::filter(season == seasons[i])
  
  # Compute actual statistics by season
  nfl_actualStats_offense_seasonalList[[i]] <- 
    nflfastR::calculate_player_stats(
      nfl_pbp_seasonalList[[i]],
      weekly = FALSE)
  
  nfl_actualStats_defense_seasonalList[[i]] <- 
    nflfastR::calculate_player_stats_def(
      nfl_pbp_seasonalList[[i]],
      weekly = FALSE)
  
  nfl_actualStats_kicking_seasonalList[[i]] <- 
    nflfastR::calculate_player_stats_kicking(
      nfl_pbp_seasonalList[[i]],
      weekly = FALSE)
  
  nfl_actualStats_offense_seasonalList[[i]]$season <- seasons[i]
  nfl_actualStats_defense_seasonalList[[i]]$season <- seasons[i]
  nfl_actualStats_kicking_seasonalList[[i]]$season <- seasons[i]
  
  print(
    paste("Completed computing projections for season: ", seasons[i], sep = ""))
  
  # Update the progress bar
  setTxtProgressBar(pb, i)
}
  
# Close the progress bar
close(pb)
  
nfl_actualStats_offense_seasonal_raw <- nfl_actualStats_offense_seasonalList %>% 
  dplyr::bind_rows()
nfl_actualStats_defense_seasonal_raw <- nfl_actualStats_defense_seasonalList %>% 
  dplyr::bind_rows()
nfl_actualStats_kicking_seasonal_raw <- nfl_actualStats_kicking_seasonalList %>% 
  dplyr::bind_rows()
```
  
```{r}
#| eval: false

save(
  nfl_actualStats_offense_seasonal_raw, nfl_actualStats_defense_seasonal_raw, nfl_actualStats_kicking_seasonal_raw,
  file = "./data/nfl_actualStats_seasonal_raw.RData"
)
```
  
```{r}
#| include: false

load("./data/nfl_actualStats_seasonal_raw.RData")
```
  
The `nfl_actualStats_seasonal` objects are in `player`-`season` form.
That is, each row should be uniquely identified by the combination of `player_id` and `season`.
Let's rearrange the data accordingly:

```{r}
nfl_actualStats_offense_seasonal <- nfl_actualStats_offense_seasonal_raw %>% 
  select(player_id, season, everything()) %>% 
  arrange(player_display_name, player_id, season)

nfl_actualStats_defense_seasonal <- nfl_actualStats_defense_seasonal_raw %>% 
  select(player_id, season, everything()) %>% 
  arrange(player_display_name, player_id, season)

nfl_actualStats_kicking_seasonal <- nfl_actualStats_kicking_seasonal_raw %>% 
  select(player_id, season, everything()) %>% 
  arrange(player_display_name, player_id, season)
```

Let's check for duplicate `player` instances:
    
```{r}
nfl_actualStats_offense_seasonal %>% 
  group_by(player_id, season) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_defense_seasonal %>% 
  group_by(player_id, season) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_kicking_seasonal %>% 
  group_by(player_id, season) %>% 
  filter(n() > 1) %>% 
  head()
```
  
Let's do some data cleanup:

```{r}
# Sum statistics across a player's years with multiple teams
nfl_actualStats_defense_seasonal <- nfl_actualStats_defense_seasonal %>% 
  group_by(player_id, season) %>% 
  summarise(
    across(where(is.numeric), ~ sum(.x, na.rm = TRUE)),
    .groups = "drop"
  )

nfl_actualStats_kicking_seasonal <- nfl_actualStats_kicking_seasonal %>% 
  group_by(player_id, season) %>% 
  summarise(
    across(where(is.numeric), ~ sum(.x, na.rm = TRUE)),
    .groups = "drop"
  )

# Re-calculate percentage stats
nfl_actualStats_kicking_seasonal <- nfl_actualStats_kicking_seasonal %>% 
  mutate(
    fg_pct = fg_made / fg_att,
    pat_pct = pat_made / pat_att
  )

# Merge data back with player info
nfl_actualStats_defense_seasonal_raw_playerInfo <- nfl_actualStats_defense_seasonal_raw %>% 
  select(player_id, season, player_name, player_display_name, position, position_group, team, headshot_url) %>% 
  unique() %>% 
  group_by(player_id) %>% 
  slice_head(n = 1) %>% 
  ungroup()

nfl_actualStats_kicking_seasonal_raw_playerInfo <- nfl_actualStats_kicking_seasonal_raw %>% 
  select(player_id, season, player_name, player_display_name, position, position_group, team, headshot_url) %>% 
  unique() %>% 
  group_by(player_id) %>% 
  slice_head(n = 1) %>% 
  ungroup()

nfl_actualStats_defense_seasonal <- nfl_actualStats_defense_seasonal_raw_playerInfo %>% 
  right_join(
    nfl_actualStats_defense_seasonal,
    by = c("player_id","season")
  )

nfl_actualStats_kicking_seasonal <- nfl_actualStats_kicking_seasonal_raw_playerInfo %>% 
  right_join(
    nfl_actualStats_kicking_seasonal,
    by = c("player_id","season")
  )

# Rearrange data
nfl_actualStats_defense_seasonal <- nfl_actualStats_defense_seasonal %>% 
  select(player_id, season, everything()) %>% 
  arrange(player_display_name, player_id, season)

nfl_actualStats_kicking_seasonal <- nfl_actualStats_kicking_seasonal %>% 
  select(player_id, season, everything()) %>% 
  arrange(player_display_name, player_id, season)
```
  
Let's check again for duplicate `player` instances:

```{r}
nfl_actualStats_offense_seasonal %>% 
  group_by(player_id, season) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_defense_seasonal %>% 
  group_by(player_id, season) %>% 
  filter(n() > 1) %>% 
  head()

nfl_actualStats_kicking_seasonal %>% 
  group_by(player_id, season) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
#| eval: false
#| include: false

save(
  nfl_actualStats_offense_seasonal, nfl_actualStats_defense_seasonal, nfl_actualStats_kicking_seasonal,
  file = "./data/nfl_actualStats_seasonal.RData"
)
```

```{r}
#| include: false

load(file = "./data/nfl_actualStats_seasonal.RData")
```

#### Week-by-Week Statistics {#sec-calculateActualWeeklyStats}

We already load players' week-by-week statistics [above](#sec-downloadActualStats).
  Nevertheless, we could compute players' weekly statistics from the play-by-play data using the following syntax:

```{r}
#| eval: false

nfl_actualStats_offense_weekly <- nflfastR::calculate_player_stats(
  nfl_pbp,
  weekly = TRUE)

nfl_actualStats_defense_weekly <- nflfastR::calculate_player_stats_def(
  nfl_pbp,
  weekly = TRUE)

nfl_actualStats_kicking_weekly <- nflfastR::calculate_player_stats_kicking(
  nfl_pbp,
  weekly = TRUE)
```

```{r}
#| include: false

# garbage collection
rm(nfl_pbp)
gc()
```

### Historical Actual Fantasy Points {#sec-calculateActualPoints}

Specify scoring settings:

#### Weekly {#sec-calculateActualPointsWeekly}

#### Seasonal {#sec-calculateActualPointsSeasonal}

#### Career {#sec-calculateActualPointsCareer}

### Player Age and Experience {#sec-calculatePlayerAge}

#### Weekly {#sec-calculatePlayerAgeWeekly}

```{r}
# Reshape from wide to long format
nfl_actualStats_offense_weekly_long <- nfl_actualStats_offense_weekly %>% 
  tidyr::pivot_longer(
    cols = c(recent_team, opponent_team),
    names_to = "role",
    values_to = "team")

# Perform separate inner join operations for the home_team and away_team
nfl_actualStats_offense_weekly_home <- dplyr::inner_join(
  nfl_actualStats_offense_weekly_long,
  nfl_schedules,
  by = c("season","week","team" = "home_team")) %>% 
  mutate(home_away = "home_team")

nfl_actualStats_offense_weekly_away <- dplyr::inner_join(
  nfl_actualStats_offense_weekly_long,
  nfl_schedules,
  by = c("season","week","team" = "away_team")) %>% 
  mutate(home_away = "away_team")

nfl_actualStats_defense_weekly_home <- dplyr::inner_join(
  nfl_actualStats_defense_weekly,
  nfl_schedules,
  by = c("season","week","team" = "home_team")) %>% 
  mutate(home_away = "home_team")

nfl_actualStats_defense_weekly_away <- dplyr::inner_join(
  nfl_actualStats_defense_weekly,
  nfl_schedules,
  by = c("season","week","team" = "away_team")) %>% 
  mutate(home_away = "away_team")

nfl_actualStats_kicking_weekly_home <- dplyr::inner_join(
  nfl_actualStats_kicking_weekly,
  nfl_schedules,
  by = c("season","week","team" = "home_team")) %>% 
  mutate(home_away = "home_team")

nfl_actualStats_kicking_weekly_away <- dplyr::inner_join(
  nfl_actualStats_kicking_weekly,
  nfl_schedules,
  by = c("season","week","team" = "away_team")) %>% 
  mutate(home_away = "away_team")

# Combine the results of the join operations
nfl_actualStats_offense_weekly_schedules_long <- dplyr::bind_rows(
  nfl_actualStats_offense_weekly_home,
  nfl_actualStats_offense_weekly_away)

nfl_actualStats_defense_weekly_schedules_long <- dplyr::bind_rows(
  nfl_actualStats_defense_weekly_home,
  nfl_actualStats_defense_weekly_away)

nfl_actualStats_kicking_weekly_schedules_long <- dplyr::bind_rows(
  nfl_actualStats_kicking_weekly_home,
  nfl_actualStats_kicking_weekly_away)

# Reshape from long to wide
player_game_gameday_offense <- nfl_actualStats_offense_weekly_schedules_long %>%
  dplyr::distinct(player_id, season, week, game_id, home_away, team, gameday) %>% #, .keep_all = TRUE
  tidyr::pivot_wider(
    names_from = home_away,
    values_from = team)

player_game_gameday_defense <- nfl_actualStats_defense_weekly_schedules_long %>%
  dplyr::distinct(player_id, season, week, game_id, home_away, team, gameday) %>% #, .keep_all = TRUE
  tidyr::pivot_wider(
    names_from = home_away,
    values_from = team)

player_game_gameday_kicking <- nfl_actualStats_kicking_weekly_schedules_long %>%
  dplyr::distinct(player_id, season, week, game_id, home_away, team, gameday) %>% #, .keep_all = TRUE
  tidyr::pivot_wider(
    names_from = home_away,
    values_from = team)

# Merge player birthdate and the game date
player_game_birthdate_gameday_offense <- dplyr::left_join(
  player_game_gameday_offense,
  unique(nfl_players[,c("gsis_id","birth_date")]),
  by = c("player_id" = "gsis_id")
)

player_game_birthdate_gameday_defense <- dplyr::left_join(
  player_game_gameday_defense,
  unique(nfl_players[,c("gsis_id","birth_date")]),
  by = c("player_id" = "gsis_id")
)

player_game_birthdate_gameday_kicking <- dplyr::left_join(
  player_game_gameday_kicking,
  unique(nfl_players[,c("gsis_id","birth_date")]),
  by = c("player_id" = "gsis_id")
)

player_game_birthdate_gameday_offense$birth_date <- lubridate::ymd(player_game_birthdate_gameday_offense$birth_date)
player_game_birthdate_gameday_offense$gameday <- lubridate::ymd(player_game_birthdate_gameday_offense$gameday)

player_game_birthdate_gameday_defense$birth_date <- lubridate::ymd(player_game_birthdate_gameday_defense$birth_date)
player_game_birthdate_gameday_defense$gameday <- lubridate::ymd(player_game_birthdate_gameday_defense$gameday)

player_game_birthdate_gameday_kicking$birth_date <- lubridate::ymd(player_game_birthdate_gameday_kicking$birth_date)
player_game_birthdate_gameday_kicking$gameday <- lubridate::ymd(player_game_birthdate_gameday_kicking$gameday)

# Calculate player's age for a given week as the difference between their birthdate and the game date
player_game_birthdate_gameday_offense$age <- lubridate::interval(
  start = player_game_birthdate_gameday_offense$birth_date,
  end = player_game_birthdate_gameday_offense$gameday
) %>% 
  lubridate::time_length(unit = "years")

player_game_birthdate_gameday_defense$age <- lubridate::interval(
  start = player_game_birthdate_gameday_defense$birth_date,
  end = player_game_birthdate_gameday_defense$gameday
) %>% 
  lubridate::time_length(unit = "years")

player_game_birthdate_gameday_kicking$age <- lubridate::interval(
  start = player_game_birthdate_gameday_kicking$birth_date,
  end = player_game_birthdate_gameday_kicking$gameday
) %>% 
  lubridate::time_length(unit = "years")

# Merge with Pro Football Reference Data on Player Age by Season
player_game_birthdate_gameday_offense <- player_game_birthdate_gameday_offense %>% 
  dplyr::left_join(
    nfl_advancedStatsPFR_seasonal %>% filter(!is.na(gsis_id), !is.na(season), !is.na(age)) %>% select(gsis_id, season, age) %>% unique(),
    by = c("player_id" = "gsis_id", "season")
  )

player_game_birthdate_gameday_defense <- player_game_birthdate_gameday_defense %>% 
  dplyr::left_join(
    nfl_advancedStatsPFR_seasonal %>% filter(!is.na(gsis_id), !is.na(season), !is.na(age)) %>% select(gsis_id, season, age) %>% unique(),
    by = c("player_id" = "gsis_id", "season")
  )

player_game_birthdate_gameday_kicking <- player_game_birthdate_gameday_kicking %>% 
  dplyr::left_join(
    nfl_advancedStatsPFR_seasonal %>% filter(!is.na(gsis_id), !is.na(season), !is.na(age)) %>% select(gsis_id, season, age) %>% unique(),
    by = c("player_id" = "gsis_id", "season")
  )

# Set age as first non-missing value from calculation above or from PFR
player_game_birthdate_gameday_offense <- player_game_birthdate_gameday_offense %>% 
  mutate(age = coalesce(age.x, age.y)) %>% 
  select(-age.x, -age.y)

player_game_birthdate_gameday_defense <- player_game_birthdate_gameday_defense %>% 
  mutate(age = coalesce(age.x, age.y)) %>% 
  select(-age.x, -age.y)

player_game_birthdate_gameday_kicking <- player_game_birthdate_gameday_kicking %>% 
  mutate(age = coalesce(age.x, age.y)) %>% 
  select(-age.x, -age.y)

# Calculate ageCentered and ageCenteredQuadratic
player_game_birthdate_gameday_offense$ageCentered20 <- player_game_birthdate_gameday_offense$age - 20
player_game_birthdate_gameday_offense$ageCentered20Quadratic <- player_game_birthdate_gameday_offense$ageCentered20 ^ 2

player_game_birthdate_gameday_defense$ageCentered20 <- player_game_birthdate_gameday_defense$age - 20
player_game_birthdate_gameday_defense$ageCentered20Quadratic <- player_game_birthdate_gameday_defense$ageCentered20 ^ 2

player_game_birthdate_gameday_kicking$ageCentered20 <- player_game_birthdate_gameday_kicking$age - 20
player_game_birthdate_gameday_kicking$ageCentered20Quadratic <- player_game_birthdate_gameday_kicking$ageCentered20 ^ 2

# Merge with player info
player_age_offense <- dplyr::left_join(
  player_game_birthdate_gameday_offense,
  nfl_players %>% select(-birth_date, -season),
  by = c("player_id" = "gsis_id"))

player_age_defense <- dplyr::left_join(
  player_game_birthdate_gameday_defense,
  nfl_players %>% select(-birth_date, -season),
  by = c("player_id" = "gsis_id"))

player_age_kicking <- dplyr::left_join(
  player_game_birthdate_gameday_kicking,
  nfl_players %>% select(-birth_date, -season),
  by = c("player_id" = "gsis_id"))

# Add game_id to weekly stats to facilitate merging
nfl_actualStats_game_offense_weekly <- nfl_actualStats_offense_weekly %>% 
  dplyr::left_join(
    player_age_offense[,c("season","week","player_id","game_id")],
    by = c("season","week","player_id"))

nfl_actualStats_game_defense_weekly <- nfl_actualStats_defense_weekly %>% 
  dplyr::left_join(
    player_age_offense[,c("season","week","player_id","game_id")],
    by = c("season","week","player_id"))

nfl_actualStats_game_kicking_weekly <- nfl_actualStats_kicking_weekly %>% 
  dplyr::left_join(
    player_age_offense[,c("season","week","player_id","game_id")],
    by = c("season","week","player_id"))

# Merge with player weekly stats
player_stats_weekly_offense <- dplyr::full_join(
  player_age_offense %>% select(-position, -position_group),
  nfl_actualStats_game_offense_weekly,
  by = c("season","week","player_id","game_id"))

player_stats_weekly_defense <- dplyr::full_join(
  player_age_defense %>% select(-position, -position_group),
  nfl_actualStats_game_defense_weekly,
  by = c("season","week","player_id","game_id"))

player_stats_weekly_kicking <- dplyr::full_join(
  player_age_kicking %>% select(-position, -position_group),
  nfl_actualStats_game_kicking_weekly,
  by = c("season","week","player_id","game_id"))

player_stats_weekly_offense$total_years_of_experience <- as.integer(player_stats_weekly_offense$years_of_experience)
player_stats_weekly_defense$total_years_of_experience <- as.integer(player_stats_weekly_defense$years_of_experience)
player_stats_weekly_kicking$total_years_of_experience <- as.integer(player_stats_weekly_kicking$years_of_experience)

player_stats_weekly_offense$years_of_experience <- NULL
player_stats_weekly_defense$years_of_experience <- NULL
player_stats_weekly_kicking$years_of_experience <- NULL

distinct_seasons_offense <- player_stats_weekly_offense %>%
  dplyr::select(player_id, season) %>%
  dplyr::distinct() %>% 
  dplyr::left_join(
    nfl_players[,c("gsis_id","years_of_experience")],
    by = c("player_id" = "gsis_id")
  ) %>% 
  dplyr::mutate(total_years_of_experience = as.integer(years_of_experience)) %>% 
  dplyr::select(-years_of_experience)

distinct_seasons_defense <- player_stats_weekly_defense %>%
  dplyr::select(player_id, season) %>%
  dplyr::distinct() %>% 
  dplyr::left_join(
    nfl_players[,c("gsis_id","years_of_experience")],
    by = c("player_id" = "gsis_id")
  ) %>% 
  dplyr::mutate(total_years_of_experience = as.integer(years_of_experience)) %>% 
  dplyr::select(-years_of_experience)

distinct_seasons_kicking <- player_stats_weekly_kicking %>%
  dplyr::select(player_id, season) %>%
  dplyr::distinct() %>% 
  dplyr::left_join(
    nfl_players[,c("gsis_id","years_of_experience")],
    by = c("player_id" = "gsis_id")
  ) %>% 
  dplyr::mutate(total_years_of_experience = as.integer(years_of_experience)) %>% 
  dplyr::select(-years_of_experience)

years_of_experience_offense <- distinct_seasons_offense %>% 
  dplyr::arrange(player_id, -season) %>% 
  dplyr::group_by(player_id) %>%
  dplyr::mutate(years_of_experience = first(total_years_of_experience) - (row_number() - 1)) %>%
  dplyr::ungroup()

years_of_experience_defense <- distinct_seasons_defense %>% 
  dplyr::arrange(player_id, -season) %>% 
  dplyr::group_by(player_id) %>%
  dplyr::mutate(years_of_experience = first(total_years_of_experience) - (row_number() - 1)) %>%
  dplyr::ungroup()

years_of_experience_kicking <- distinct_seasons_kicking %>% 
  dplyr::arrange(player_id, -season) %>% 
  dplyr::group_by(player_id) %>%
  dplyr::mutate(years_of_experience = first(total_years_of_experience) - (row_number() - 1)) %>%
  dplyr::ungroup()

years_of_experience_offense$years_of_experience[which(years_of_experience_offense$years_of_experience < 0)] <- 0
years_of_experience_defense$years_of_experience[which(years_of_experience_defense$years_of_experience < 0)] <- 0
years_of_experience_kicking$years_of_experience[which(years_of_experience_kicking$years_of_experience < 0)] <- 0

player_stats_weekly_offense <- player_stats_weekly_offense %>% 
  dplyr::left_join(
    years_of_experience_offense[,c("player_id","season","years_of_experience")],
    by = c("player_id","season")
  )

player_stats_weekly_defense <- player_stats_weekly_defense %>% 
  dplyr::left_join(
    years_of_experience_offense[,c("player_id","season","years_of_experience")],
    by = c("player_id","season")
  )

player_stats_weekly_kicking <- player_stats_weekly_kicking %>% 
  dplyr::left_join(
    years_of_experience_offense[,c("player_id","season","years_of_experience")],
    by = c("player_id","season")
  )
```

The `player_stats_weekly` objects are in `player`-`season`-`week` form.
That is, each row should be uniquely identified by the combination of `player_id`, `season`, and `week`.
Let's rearrange the data accordingly:

```{r}
player_stats_weekly_offense <- player_stats_weekly_offense %>% 
  arrange(player_display_name, player_id, season, week)

player_stats_weekly_defense <- player_stats_weekly_defense %>% 
  arrange(player_display_name, player_id, season, week)

player_stats_weekly_kicking <- player_stats_weekly_kicking %>% 
  arrange(player_display_name, player_id, season, week)
```

Let's check for duplicate `player`-`season`-`week` instances:
  
```{r}
player_stats_weekly_offense %>% 
  group_by(player_id, season, week) %>% 
  filter(n() > 1) %>% 
  head()

player_stats_weekly_defense %>% 
  group_by(player_id, season, week) %>% 
  filter(n() > 1) %>% 
  head() #todo: fix duplicate instances

player_stats_weekly_kicking %>% 
  group_by(player_id, season, week) %>% 
  filter(n() > 1) %>% 
  head() #todo: fix duplicate instances
```

```{r}
# Save data
save(
  player_stats_weekly_offense, player_stats_weekly_defense, player_stats_weekly_kicking,
  file = "./data/player_stats_weekly.RData"
)
```

#### Seasonal {#sec-calculatePlayerAgeSeasonal}

```{r}
# Merge player info with seasonal stats
player_stats_seasonal_offense <- dplyr::full_join(
  nfl_actualStats_offense_seasonal,
  nfl_players %>% select(-position, -position_group, -season),
  by = c("player_id" = "gsis_id")
)

player_stats_seasonal_defense <- dplyr::full_join(
  nfl_actualStats_defense_seasonal,
  nfl_players %>% select(-position, -position_group, -season),
  by = c("player_id" = "gsis_id")
)

player_stats_seasonal_kicking <- dplyr::full_join(
  nfl_actualStats_kicking_seasonal,
  nfl_players %>% select(-position, -position_group, -season),
  by = c("player_id" = "gsis_id")
)

# Calculate age
season_startdate <- nfl_schedules %>% 
  dplyr::group_by(season) %>% 
  dplyr::summarise(startdate = min(gameday, na.rm = TRUE))

player_stats_seasonal_offense <- player_stats_seasonal_offense %>% 
  dplyr::left_join(
    season_startdate,
    by = "season"
  )

player_stats_seasonal_defense <- player_stats_seasonal_defense %>% 
  dplyr::left_join(
    season_startdate,
    by = "season"
  )

player_stats_seasonal_kicking <- player_stats_seasonal_kicking %>% 
  dplyr::left_join(
    season_startdate,
    by = "season"
  )

player_stats_seasonal_offense$age <- lubridate::interval(
  start = player_stats_seasonal_offense$birth_date,
  end = player_stats_seasonal_offense$startdate
) %>% 
  lubridate::time_length(unit = "years")

player_stats_seasonal_defense$age <- lubridate::interval(
  start = player_stats_seasonal_defense$birth_date,
  end = player_stats_seasonal_defense$startdate
) %>% 
  lubridate::time_length(unit = "years")

player_stats_seasonal_kicking$age <- lubridate::interval(
  start = player_stats_seasonal_kicking$birth_date,
  end = player_stats_seasonal_kicking$startdate
) %>% 
  lubridate::time_length(unit = "years")

# Merge with Pro Football Reference Data on Player Age by Season
player_stats_seasonal_offense <- player_stats_seasonal_offense %>% 
  dplyr::left_join(
    nfl_advancedStatsPFR_seasonal %>% filter(!is.na(gsis_id), !is.na(season), !is.na(age)) %>% select(gsis_id, season, age) %>% unique(),
    by = c("player_id" = "gsis_id", "season")
  )

player_stats_seasonal_defense <- player_stats_seasonal_defense %>% 
  dplyr::left_join(
    nfl_advancedStatsPFR_seasonal %>% filter(!is.na(gsis_id), !is.na(season), !is.na(age)) %>% select(gsis_id, season, age) %>% unique(),
    by = c("player_id" = "gsis_id", "season")
  )

player_stats_seasonal_kicking <- player_stats_seasonal_kicking %>% 
  dplyr::left_join(
    nfl_advancedStatsPFR_seasonal %>% filter(!is.na(gsis_id), !is.na(season), !is.na(age)) %>% select(gsis_id, season, age) %>% unique(),
    by = c("player_id" = "gsis_id", "season")
  )

# Set age as first non-missing value from calculation above or from PFR
player_stats_seasonal_offense <- player_stats_seasonal_offense %>% 
  mutate(age = coalesce(age.x, age.y)) %>% 
  select(-age.x, -age.y)

player_stats_seasonal_defense <- player_stats_seasonal_defense %>% 
  mutate(age = coalesce(age.x, age.y)) %>% 
  select(-age.x, -age.y)

player_stats_seasonal_kicking <- player_stats_seasonal_kicking %>% 
  mutate(age = coalesce(age.x, age.y)) %>% 
  select(-age.x, -age.y)

# Calculate ageCentered and ageCenteredQuadratic
player_stats_seasonal_offense$ageCentered20 <- player_stats_seasonal_offense$age - 20
player_stats_seasonal_offense$ageCentered20Quadratic <- player_stats_seasonal_offense$ageCentered20 ^ 2

player_stats_seasonal_defense$ageCentered20 <- player_stats_seasonal_defense$age - 20
player_stats_seasonal_defense$ageCentered20Quadratic <- player_stats_seasonal_defense$ageCentered20 ^ 2

player_stats_seasonal_kicking$ageCentered20 <- player_stats_seasonal_kicking$age - 20
player_stats_seasonal_kicking$ageCentered20Quadratic <- player_stats_seasonal_kicking$ageCentered20 ^ 2

# Years of experience
player_stats_seasonal_offense$years_of_experience <- NULL
player_stats_seasonal_defense$years_of_experience <- NULL
player_stats_seasonal_kicking$years_of_experience <- NULL

player_stats_seasonal_offense <- player_stats_seasonal_offense %>% 
  dplyr::left_join(
    years_of_experience_offense[,c("player_id","season","years_of_experience")],
    by = c("player_id","season")
  )

player_stats_seasonal_defense <- player_stats_seasonal_defense %>% 
  dplyr::left_join(
    years_of_experience_offense[,c("player_id","season","years_of_experience")],
    by = c("player_id","season")
  )

player_stats_seasonal_kicking <- player_stats_seasonal_kicking %>% 
  dplyr::left_join(
    years_of_experience_offense[,c("player_id","season","years_of_experience")],
    by = c("player_id","season")
  )
```

The `player_stats_seasonal` objects are in `player`-`season` form.
That is, each row should be uniquely identified by the combination of `player_id` and `season`.
Let's rearrange the data accordingly:

```{r}
player_stats_seasonal_offense <- player_stats_seasonal_offense %>% 
  select(player_id, season, everything()) %>% 
  arrange(player_display_name, player_id, season)

player_stats_seasonal_defense <- player_stats_seasonal_defense %>% 
  select(player_id, season, everything()) %>% 
  arrange(player_display_name, player_id, season)

player_stats_seasonal_kicking <- player_stats_seasonal_kicking %>% 
  select(player_id, season, everything()) %>% 
  arrange(player_display_name, player_id, season)
```

Let's check for duplicate `player`-`season` instances:
  
```{r}
player_stats_seasonal_offense %>% 
  group_by(player_id, season) %>% 
  filter(n() > 1) %>% 
  head()

player_stats_seasonal_defense %>% 
  group_by(player_id, season) %>% 
  filter(n() > 1) %>% 
  head()

player_stats_seasonal_kicking %>% 
  group_by(player_id, season) %>% 
  filter(n() > 1) %>% 
  head()
```

```{r}
# Save data
save(
  player_stats_seasonal_offense, player_stats_seasonal_defense, player_stats_seasonal_kicking,
  file = "./data/player_stats_seasonal.RData"
)
```

::: {.content-visible when-format="html"}

## Session Info {#sec-downloadFootballDataSessionInfo}

```{r}
sessionInfo()
```

:::
  